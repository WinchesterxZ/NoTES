# Active Directory (AD) – Introduction Notes

## What is Active Directory (AD)
Active Directory is a Microsoft service used to manage **users, devices, permissions, and resources** in a Windows network.

---
## DOMAIN vs DOMAIN CONTROLLER (DC)

### Domain
- A **Domain** is a **logical structure**
- All devices, users, and resources belong to it
- It contains:
  - Users
  - Groups
  - Devices
  - Organizational Units (OU)
  - Policies

### Domain Controller (DC)
- A **DC is the physical (or virtual) server**
- AD services run on it
- It stores and manages authentication and authorization
- It holds the **NTDS.dit** database

### Windows Server
- Windows Server is a **special OS**
- It has Active Directory services
- It is installed on a machine that becomes a **Domain Controller**

---

## DOMAIN COMPONENTS

### Users
- People with normal accounts in AD
### Groups
- A group of users
- Used to assign permissions easily
### Organizational Unit (OU)
- A container that can hold:
  - Users
  - Groups
  - Devices
  - Other OUs
- Used for organization and applying policies
### Devices
- Computers and servers joined to the domain

---
## ACCESS CONTROL LIST (ACL)
- Controls **permissions**
- Determines:
  - Who can access what
  - What actions are allowed
- Applies to:
  - Users
  - Groups
  - Devices
  - Services

---

## WHY TRUST EXISTS
- Because **load on one DC can be high**
- Microsoft introduced **Trust and Replication**
- This improves:
  - Availability
  - Performance
  - Reliability

---

## TRUST & REPLICATION

### Trust
- A relationship between domains
- Allows users from one domain to access resources in another

### Replication
- Data is copied between DCs
- Like taking a snapshot from one DC and running it on another DC

### Load Balancing
- If the main DC is busy
- A replicated DC can answer authentication requests
- This improves performance

---

## SUBDOMAINS & TRUST MODEL

Microsoft decided to use **subdomains** for better trust management.

### Example:
bank.local  
├── eg.bank.local  
└── sa.bank.local

### Trust Relationship
- Parent trusts child
- Child trusts parent
- This is a **two-way trust**

---

## ADMIN GROUPS

### Domain Admins (DA)
- Exists in every domain
- Full control over that domain

### Enterprise Admins (EA)
- Created when multiple domains exist
- Parent Domain Admin is promoted to **Enterprise Admin**
- Can manage **all subdomains**

---

# AUTHENTICATION

## Windows Local Authentication (No Domain)

When you log in to your **own PC**:

1. Device takes the password
2. Converts it to **NTLM hash** (MD4 hashing)
3. Checks the **SAM file**
   - SAM contains all local users and their hashes
4. If hashes match → login success
5. If not → wrong password

---

## Network Authentication – NTLMv2

Used when accessing a **service on another device**.

### Steps:
1. Your PC calculates NTLM hash of your password
2. Requests authentication from the service
3. Service sends a **nonce** and keeps a copy
4. Your PC encrypts the nonce using NTLM hash
5. Service sends:
   - Username
   - Nonce
   - Encrypted nonce
   → to the DC
6. DC looks up the user in **NTDS.dit**
7. DC encrypts the nonce using stored NTLM hash
8. DC compares both encrypted nonces
   - If match → authentication success

### Note:
- NTDS.dit is like the **SAM file but for domains**
- It contains domain users and their hashes

---

## KERBEROS AUTHENTICATION (NETWORK)

### Tickets
- **TGT (Ticket Granting Ticket)** → for user
- **TGS (Ticket Granting Service)** → for service

---

### Kerberos Steps:

1. User logs in
2. NTLM hash is calculated
3. User sends **AS-REQ** to DC:
   - Includes timestamp
   - Timestamp encrypted with NTLM hash
4. DC:
   - Searches user in NTDS.dit
   - Encrypts timestamp with NTLM hash
   - If valid → sends **AS-REP**
   - AS-REP contains **TGT**
5. User wants a service:
   - Sends **TGS-REQ + TGT**
6. DC checks service
7. DC replies with **TGS**
8. User sends TGS to the service
9. Service may:
   - Accept directly
   - Or verify with DC

---

## IMPORTANT NOTES

- When AD is created:
  - A user called **krbtgt** is created by default
- krbtgt:
  - Signs all TGT tickets
  - Second most critical account after Administrator
- TGS:
  - Encrypted by the **service itself**
