# Nmap Live Host Discovery

## 1. Introduction to Nmap
**Nmap** (Network Mapper) is the industry standard open-source tool for network discovery and security auditing. It maps out network structures by identifying live hosts, open ports, and operating system details. It also includes the **Nmap Scripting Engine (NSE)**, which extends its capabilities to include vulnerability scanning and advanced exploitation.

An Nmap scan generally follows a specific sequence of steps, though users can skip or customize these using command-line arguments.

---

## 2. Understanding Subnetworks
To understand scanning, you must understand how networks are divided.
* **Definition:** A subnet is a logical subdivision of an IP network. It groups devices together (like a neighborhood) to improve performance and security.
* **Routing:** Traffic *within* a subnet allows devices to talk directly via MAC addresses. Traffic *leaving* a subnet must go through a gateway (router).

### The Role of ARP (Address Resolution Protocol)
ARP is the bridge between Layer 3 (IP addresses) and Layer 2 (MAC addresses).

1.  **Local Scan:** If you scan a machine on your *own* subnet (e.g., `10.1.1.5` scanning `10.1.1.10`), Nmap uses ARP. It broadcasts "Who has this IP?" and the target replies with its hardware address. This is extremely fast and reliable.
2.  **Remote Scan:** ARP cannot cross routers. If you scan a machine on a *different* subnet, ARP packets are blocked at the gateway. You must rely on routable protocols like ICMP, TCP, or UDP.

### Practice Questions: Subnetworks

**Task 1 (Local Traffic)**
*Scenario:* Computer1 sends an ARP Request to Computer1 (Broadcast) asking for Computer6.
* **How many devices can see the ARP Request?** `4` (All devices in the switch/hub domain see broadcast).
* **Did computer6 receive the ARP Request?** `No` (Likely implies Computer6 is offline or unreachable in this specific simulation).

**Task 2 (Broadcasts)**
*Scenario:* Computer4 sends a broadcast ARP Request asking for Computer6.
* **How many devices can see the ARP Request?** `4`.
* **Did computer6 receive the ARP Request?** `Yes`.

---

## 3. Enumerating Targets
Before scanning, you must define the scope. Nmap allows flexible target specification.

| Type | Command Example | Description |
| :--- | :--- | :--- |
| **List** | `nmap 10.1.1.1 scanme.nmap.org` | Scans individual IPs or domains. |
| **Range** | `nmap 10.11.12.15-20` | Scans a sequential range of IPs. |
| **Subnet** | `nmap 10.1.1.0/30` | Scans an entire CIDR block (subnet). |
| **File** | `nmap -iL hosts.txt` | Imports a list of targets from a file. |

### The List Scan (`-sL`)
If you want to list the targets Nmap *would* scan without sending any packets to them, use `-sL`. This performs Reverse-DNS lookups to find hostnames, which often reveals naming conventions (e.g., `dev-server.corp.local`).
* **Tip:** Use `-n` to disable DNS resolution for speed.

### Practice Questions: Enumerating Targets
**Task 1**
* **Q:** What is the first IP address Nmap would scan if you provided `10.10.12.13/29` as your target?
* **A:** `10.10.12.8` (This is the network address of that CIDR block).

**Task 2**
* **Q:** How many IP addresses will Nmap scan if you provide the range `10.10.0-255.101-125`?
* **A:** `6400` (256 options for the third octet * 25 options for the fourth octet).

---

## 4. Discovery Protocol Fundamentals
Scanners use various protocols to ask the question: "Is anyone home?"

1.  **ARP:** Link-layer. Fast. Local-only.
2.  **ICMP:** Network-layer (Ping). Routable. Often blocked by firewalls.
3.  **TCP/UDP:** Transport-layer. Sends packets to specific ports (e.g., 80, 443). If a service responds (or rejects), the host is up.

> Key Rule
> If you are on the same LAN, Nmap defaults to **ARP**.
> If you are remote, Nmap defaults to **ICMP/TCP**.

### Practice Questions: Discovery Logic
**Task 1 (Local Ping)**
*Scenario:* Computer1 pings Computer3.
* **Q:** What packet did Computer1 send *before* the ping?
    * **A:** ARP Request (It needs the MAC address first).
* **Q:** What did it receive back?
    * **A:** ARP Response.
* **Q:** How many computers responded to the ping?
    * **A:** 1.

**Task 2 (Remote Ping)**
*Scenario:* Computer2 pings Computer5 (across a router).
* **Q:** Who responded to the first ARP Request?
    * **A:** Router (The gateway acts as the proxy for remote traffic).
* **Q:** Who responded to the second ARP Request (on the other side)?
    * **A:** Computer5.
* **Q:** Did a second Ping Request require new ARP requests?
    * **A:** N (The ARP cache stores the address for a short time).

---

## 5. Nmap Host Discovery: ARP (`-PR`)
When scanning a local ethernet network, ARP is the gold standard. It allows you to scan for "live" hosts without probing specific ports.

* **Flag:** `-PR` (ARP Ping)
* **Flag:** `-sn` (Disable port scanâ€”Host Discovery Only)
* **Command:** `sudo nmap -PR -sn 10.10.210.6/24`

### Alternative Tool: `arp-scan`
A specialized tool just for this purpose. It is excellent for mapping a physical network quickly.
* **Command:** `sudo arp-scan -I eth0 -l`

### Practice Questions: ARP
* **Q:** Using a broadcast ARP request to query all 8 devices on the network, how many devices are you able to discover?
* **A:** `3` (Only the live devices responded).

---

## 6. Nmap Host Discovery: ICMP (`-PE`, `-PP`, `-PM`)
When scanning remote networks, we often use ICMP (Ping). However, standard Pings are often blocked by Windows Firewall or corporate firewalls. Nmap offers three variations to bypass this.

| Flag | ICMP Type | Description |
| :--- | :--- | :--- |
| **-PE** | Echo Request (Type 8) | Standard "Ping". Good for friendly networks. |
| **-PP** | Timestamp Request (Type 13) | Asks the target for the time. Often bypasses block on Echo. |
| **-PM** | Address Mask (Type 17) | Asks for subnet mask. Rarely works, but good fallback. |

### Practice Questions: ICMP
* **Q:** What option tells Nmap to use ICMP Timestamp?
    * **A:** `-PP`
* **Q:** What option tells Nmap to use ICMP Address Mask?
    * **A:** `-PM`
* **Q:** What option tells Nmap to use ICMP Echo?
    * **A:** `-PE`

---

## 7. Nmap Host Discovery: TCP & UDP (`-PS`, `-PA`, `-PU`)
If ICMP is blocked completely, we use TCP/UDP packets. If a computer responds to a TCP packet (even with an error like "Reset"), it proves the computer is online.

* **TCP SYN Ping (`-PS`):** Sends a SYN packet (like starting a connection).
    * Open Port: Replies SYN/ACK.
    * Closed Port: Replies RST (Reset).
    * *Conclusion:* Both mean the host is **UP**.
* **TCP ACK Ping (`-PA`):** Sends an ACK packet (pretending a connection already exists).
    * Target: "I don't know this connection" -> Sends RST.
    * *Conclusion:* Host is **UP**.
* **UDP Ping (`-PU`):** Sends data to a UDP port (usually a high random port).
    * Target: "Port Unreachable" (ICMP error).
    * *Conclusion:* Host is **UP**.

### Masscan
An aggressive alternative to Nmap designed for speed. It uses similar techniques but transmits packets asynchronously to scan the entire internet in minutes.

---

## 8. Reverse DNS Lookup (`-R`, `-n`)
Once hosts are found, you may want to know their names.

* **Default:** Nmap resolves hostnames for online hosts.
* **`-n`:** **Never** resolve DNS (Speeds up scans significantly).
* **`-R`:** **Always** resolve DNS (Even for offline hosts).
* **`--dns-servers`:** Use a specific DNS server (e.g., 8.8.8.8) to bypass local DNS issues or logging.

### Practice Questions: Reverse DNS
* **Q:** We want Nmap to issue a reverse DNS lookup for all possible hosts on a subnet to gain insights. What option should we add?
* **A:** `-R`