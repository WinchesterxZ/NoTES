# Root Me: File Upload - ZIP

**Objective:** exploit a ZIP file upload function to read the source code (`index.php`) and retrieve the flag.

---

## 1. Reconnaissance

I began by attempting to upload non-ZIP files to test the server's validation. The server returned a specific PHP warning, confirming that the backend uses the `ZipArchive` class to handle uploads.

```text
Warning: ZipArchive::close(): Invalid or uninitialized Zip object in /challenge/web-serveur/ch51/index.php on line 19
```

![[Pasted image 20251127053716.png]]

### Failed RCE Attempt

I attempted to upload a ZIP containing a PHP web shell (`shell.php`). While the upload succeeded and the file was extracted, I received a **403 Forbidden** error when trying to access the `.php` file directly.

![[Pasted image 20251127053943.png]]

**Analysis:** The web server likely has an `.htaccess` rule or configuration in the upload directory that prevents the execution of `.php` files. I need a way to read files outside this directory.

## 2. Vulnerability Analysis

Since I cannot execute code, I shifted my strategy to **Local File Disclosure**.

The PHP `ZipArchive` class, if not configured correctly, will extract **Symbolic Links** (symlinks) exactly as they are. If I create a symlink that points to a sensitive file (like `index.php`) and upload it, the web server might follow that link and display the file content.

## 3. Exploitation

I used a Linux terminal to create a malicious ZIP file containing a symbolic link.

### Step 1: Create the Symlink

I created a symlink named `test.txt` that points backwards three directories (`../../../`) to the root `index.php`.

```bash
ln -s ../../../index.php test.txt
```
_(Note: I used `.txt` because `.html` did not render the PHP source code as text)._

### Step 2: Create the ZIP

I zipped the file using the `--symlinks` flag. **This is crucial.** Without this flag, the zip command would follow the link and try to copy the _content_ of the target file (which we don't have on our local machine). We want to zip the _pointer_ itself.
```bash
zip --symlinks test.zip test.txt
```
**Output:**
```
adding: test.txt (stored 0%)
```
## 4. Execution

1. I uploaded `test.zip` to the server.
    
2. The server extracted the ZIP, placing `test.txt` in the upload folder.
    
3. I accessed the text file via the browser.
    

Because `test.txt` is actually a link to `index.php`, and the browser treats it as a text file, the server displayed the raw PHP source code of the index page.

![[Pasted image 20251127060808.png]]

I analyzed the source code, found the flag/password, and validated the challenge.

![[Pasted image 20251127061117.png]]