# Lab 6: Brute-forcing a Stay-logged-in Cookie

This lab provides a "Remember me" functionality that allows users to stay logged in after closing their browser. The vulnerability lies in the structure of the cookie used for this feature, which can be reverse-engineered and brute-forced.

To solve the lab, we must deduce the cookie format and brute-force Carlos's cookie to gain access to his **My Account** page.

**Lab Details:**
- **My Credentials:** `wiener:peter`
- **Victim Username:** `carlos`
- **Wordlist:** [Candidate passwords](https://portswigger.net/web-security/authentication/auth-lab-passwords)

---

## 1. Investigation & Vulnerability Analysis

### Initial Brute-Force Attempt
The first logical step was to attempt a standard brute-force attack against the login form using the username `carlos` and the candidate password list.
![[Pasted image 20251120181308.png]]

**Result:** The application implements strict rate limiting. After a few incorrect attempts, the server blocked further login requests. This confirms that we cannot attack the login form directly and must find an alternative entry point.
![[Pasted image 20251120181042.png]]

### Analyzing the "Stay Logged In" Cookie
I logged in using my valid credentials (`wiener:peter`) and intentionally checked the **"Stay logged in"** box to generate the persistence cookie.
![[Pasted image 20251120180421.png]]

 upon inspecting the request in Burp Suite, I noticed a new cookie named `stay-logged-in`. The value appeared to be a Base64 encoded string.

**Decoding the Cookie:**
I sent the cookie value to Burp Decoder.
1.  **Original Value:** `d2llbmVyOjUxZGMzMGRkYzQ3M2Q0M2E2MDExZTllYmJhNmNhNzcw`
2.  **Base64 Decode:** `wiener:51dc30ddc473d43a6011e9ebba6ca770`

**Hypothesis:**
The cookie structure is `username:hash`.
I recognized the hash part (`51dc30dd...`) as a standard MD5 hash. To confirm, I hashed my password (`peter`) using MD5.
- `MD5("peter")` = `51dc30ddc473d43a6011e9ebba6ca770`

**Conclusion:**
The cookie generation algorithm is:
`Base64(username:MD5(password))`

![[Pasted image 20251120181450.png]]

---

## 2. Developing the Exploit Strategy

Now that we know the formula, we can generate a valid cookie for `carlos` if we guess his password correctly.

### Identifying the Target Request
We need to target a page that requires authentication to test our forged cookies. The `/my-account` endpoint is the perfect candidate.

I intercepted a request to `/my-account?id=carlos`.
![[Pasted image 20251120183205.png]]

**Crucial Technical Detail:**
If we send the request with both the `session` cookie and the `stay-logged-in` cookie, the server prioritizes the valid session and ignores our brute-force attempt.
To force the server to validate our `stay-logged-in` cookie, **we must delete the `session` cookie** from the request headers in Intruder.

---

## 3. Executing the Attack: Cookie Brute-force

We will use Burp Intruder to generate the cookie for every password in the wordlist and send it to the server.

### Burp Intruder Configuration
1.  Send the `GET /my-account` request to **Intruder**.
2.  **Clear** the existing `session` cookie.
3.  Set the `stay-logged-in` cookie value as the payload position.
4.  Select **Sniper** attack type.

**Payload Processing Rules:**
We need to transform the cleartext passwords from our wordlist into the specific cookie format expected by the server.
1.  **Payload:** Load the candidate passwords list.
2.  **Hash:** Apply **Hash: MD5**.
3.  **Prefix:** Add **Prefix** `carlos:` (This constructs the `username:hash` string).
4.  **Encode:** Apply **Encode: Base64**.

![[Pasted image 20251120185741.png]]

---

## 4. Results & Success

Start the attack. We are looking for a response that indicates the cookie was accepted.
-   **Failed Attempt:** Returns a `302 Found` redirecting back to `/login`.
-   **Successful Attempt:** Returns a `200 OK`, loading the "My Account" page.

**Outcome:**
One request returned a `200 OK` status. This indicates that the generated cookie matched the server's expectation for `carlos`.

![[Pasted image 20251120185838.png]]

By right-clicking this request and selecting "Show response in browser," or simply copying the cookie value into my browser, I successfully accessed Carlos's account page.

![[Pasted image 20251120190029.png]]
![[Pasted image 20251120190004.png]]
![[Pasted image 20251120190105.png]]