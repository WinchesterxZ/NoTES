# Lab: 2FA Broken Logic

**Objective:** Brute-force the 2FA verification code to access Carlos's account.
**Victim Credentials:** `carlos:montoya`

---

## 1. Reconnaissance & Behavior Analysis

First, I attempted a legitimate login flow using the provided credentials.

![[Pasted image 20251122223727.png]]

During the MFA stage, I observed a critical security mechanism regarding session handling:
1.  **First Attempt:** Entering an incorrect code returns an "Incorrect security code" message.
    ![[Pasted image 20251122223621.png]]
2.  **Second Attempt:** Entering an incorrect code a second time causes the application to invalidate the session and redirect back to the login page.
    ![[Pasted image 20251122223648.png]]

**Conclusion:** We cannot simply brute-force the MFA code in a standard way because the session dies after two failed attempts. We need a way to automatically re-authenticate and obtain a fresh session before every brute-force attempt.

---

## 2. Burp Suite Configuration (Macros)

To bypass the session invalidation, I configured a **Burp Macro** to handle the login flow automatically for every request sent by Intruder.

### Macro Sequence
I recorded a macro including the following steps to ensure a valid session and updated CSRF tokens:
1.  **GET /login** (Retrieve initial CSRF token)
2.  **POST /login-2fa** (Submit `carlos:montoya`)
3.  **GET /login-2fa** (Load the MFA input page)

### Session Handling Rule
I created a specific Session Handling Rule in Burp's Project Options:
* **Rule Action:** Run a Macro.
* **Scope:** Include URL scope suitable for the lab.
* **Trigger:** Update the current session cookie.

![[Pasted image 20251122224500.png]]

---

## 3. Exploitation (Intruder)

With the macro ensuring a valid session for every request, I sent the MFA verification request to **Intruder**.

### Payload Settings
* **Attack Type:** Sniper
* **Payload:** Numbers (0000 - 9999)
* **Format:** 4 digits (min integer digits: 4)

### Performance Settings
Because macros involve multiple requests per attack payload, and to avoid race conditions with session cookies, I restricted the concurrency.
* **Resource Pool:** Maximum concurrent requests = **1**.

![[Pasted image 20251122224702.png]]

### Result
After running the attack (which took considerable time due to the single-threaded restriction), I successfully identified the correct code (Status 302).

![[Pasted image 20251122233027.png]]

Using the discovered code, I accessed the account page.

![[Pasted image 20251122233235.png]]