# Lab 3: Broken Brute-force Protection, IP Block

This lab contains a vulnerability in its password brute-force protection logic. To solve the lab, we need to brute-force the victim's password, log in, and access their account page.

**Lab Details:**
- **My Credentials:** `wiener:peter`
- **Victim Username:** `carlos`
- **Wordlist:** [Candidate passwords](https://portswigger.net/web-security/authentication/auth-lab-passwords)

---

## 1. Investigation & Login Analysis

### Observations
Upon attempting to log in, I observed the following behavior:
![[Pasted image 20251119202036.png]]

1.  **Blocking Mechanism:** After **2 incorrect attempts**, the server blocks the IP address.
    ![[Pasted image 20251119202129.png]]
2.  **Bypass Attempts:**
    - I attempted to spoof headers (e.g., `X-Forwarded-For`), but this failed.
    - I attempted to rotate `User-Agent` strings, but this also failed.

### Logic Flaw Discovery
The only method that successfully reset the block counter was logging in with valid credentials (`wiener:peter`). This indicates that the application resets the failed attempt counter to zero upon a successful login.

---

## 2. Exploitation Strategy

To bypass the protection, we need to interleave our brute-force attempts with valid logins. Based on the blocking threshold (2 attempts), we can structure the attack as follows:
1.  Attempt `carlos` (Candidate Password 1)
2.  Attempt `carlos` (Candidate Password 2)
3.  **Reset Counter:** Login as `wiener` (Password: `peter`)
4.  Repeat.

We need to generate two wordlists (Usernames and Passwords) that align perfectly for a **Pitchfork** attack in Burp Intruder.

### Desired List Structure

**Username List:**
```text
carlos
carlos
wiener
...
```

**Password List:**
```
candidate_pass_1
candidate_pass_2
peter
...
```
## 3. Preparing Wordlists (Python Scripts)

I used Python to generate the necessary wordlists to automate this structure.

### Script 1: Generating the Username List

This script generates a list consisting of the victim's username (`carlos`) repeated.

```python
output_filename = "username.txt"
base_name = "carlos"
count = 100

try:
    with open(output_filename, "w") as f:
        for i in range(1, count + 1):
            username = base_name
            f.write(username + "\n")
    print(f"Successfully created '{output_filename}' with {count} usernames.")

except Exception as e:
    print(f"An error occurred: {e}")
```

### Script 2: Modifying the Password List

This script takes the standard candidate password list and inserts the valid password (`peter`) at specific intervals (every 2 lines) to reset the counter.

```
import os

def append_string_to_lines(input_filename, output_filename, string_to_append):
    try:
        with open(input_filename, 'r', encoding='utf-8') as infile, \
             open(output_filename, 'w', encoding='utf-8') as outfile:
            
            lines = infile.readlines()
            
            for i, line in enumerate(lines):
                outfile.write(line.rstrip('\n') + '\n')
                if (i + 1) % 2 == 0 and i < len(lines) - 1:
                    outfile.write(string_to_append + '\n')
                    
        print(f"Success! Check '{output_filename}' for the results.")

    except FileNotFoundError:
        print(f"Error: The file '{input_filename}' was not found.")
    except Exception as e:
        print(f"An error occurred: {e}")

# Configuration
input_file = 'passwords.txt'      
output_file = 'output_passwords.txt'      
my_string = 'peter'       

append_string_to_lines(input_file, output_file, my_string)
```
**Generated Lists Verification:** ![[Pasted image 20251120021459.png]] ![[Pasted image 20251120021516.png]]
## 4. Executing the Attack

### Burp Intruder Configuration

1. Send the login request to **Intruder**.
    
2. Set the attack type to **Pitchfork**.
    
3. Set payload markers for the `username` and `password` fields.
    

![[Pasted image 20251120015019.png]]
### Crucial Step: Resource Pool

During the initial attempt, I was blocked immediately. This happened because Burp sends requests concurrently by default, messing up the "Fail-Fail-Reset" order.

**Fix:**

- Go to the **Resource Pool** tab.
    
- Create a new resource pool.
    
- Set **Maximum concurrent requests** to **1**.
    

![[Pasted image 20251120015128.png]]

### Results

Start the attack. Monitor the results for a 302 status code (redirect) or a difference in response length that indicates a successful login for the user `carlos`.

![[Pasted image 20251120015327.png]]

![[Pasted image 20251120015406.png]]