# Lab 5: 2FA Broken Logic

This lab's two-factor authentication (2FA) mechanism is vulnerable due to flawed logic in how the verification code is validated. To solve the lab, we must bypass the 2FA check to access Carlos's account page.

**Lab Details:**
- **My Credentials:** `wiener:peter`
- **Victim Username:** `carlos`

---

## 1. Investigation & Login Analysis

### Observations
I started by logging in with valid credentials (`wiener:peter`) to analyze the standard 2FA flow.
![[Pasted image 20251120174607.png]]

- **Hypothesis:** I observed that if I enter an incorrect code repeatedly, the server does not block me. There appears to be **no rate limiting** on the 2FA code input field.

### Logic Flaw Discovery
I investigated the verification request to see if I could manipulate it to check a code for `carlos` instead of `wiener`.

1.  **Triggering the Code:** First, I attempted to log in as `carlos` to ensure the system generated a code for him.
2.  **Manipulating the Request:** I intercepted the verification request intended for `wiener`.
3.  **The Switch:** I modified the `verify` parameter (or user identifier in the request/cookie) from `wiener` to `carlos`.

![[Pasted image 20251120174709.png]]
![[Pasted image 20251120175821.png]]
**Result:** The server returned a `200 OK` with the message "Incorrect code". This confirms the vulnerability: the server allows us to verify a code for an arbitrary user without checking if the session matches that user.

![[Pasted image 20251120175032.png]]

---

## 2. Executing the Attack: 2FA Brute-force

Since there is no rate limit and we can target `carlos`, we can now brute-force the 4-digit security code.

### Burp Intruder Configuration
1.  Send the modified verification request (targeting `carlos`) to **Intruder**.
2.  Set the attack type to **Sniper**.
3.  Select the 4-digit code as the payload position.
4.  **Payload Settings (Numbers):**
    -   **Type:** Numbers
    -   **From:** `0000`
    -   **To:** `9999`
    -   **Step:** `1`
    -   **Min integer digits:** `4` (This ensures codes like `0021` are not sent as `21`).

![[Pasted image 20251120175501.png]]

### Results & Success
Start the attack. Monitor the results for a status code change (e.g., a `302 Found` redirect) or a change in response length.

**The Flaw:** Because the logic failed to validate the session against the user being verified, we successfully found the correct code and logged into Carlos's account.

![[Pasted image 20251120175936.png]]

![[Pasted image 20251120180010.png]]