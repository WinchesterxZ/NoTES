# Lab: Multi-step Process with No Access Control on One Step

**Objective:** Exploit a flaw in a multi-step administrative process to promote the user `wiener` to an administrator.
**Vulnerability:** Broken Access Control (Incomplete State Validation).
**Credentials:** `administrator:admin` (Recon), `wiener:peter` (Exploit).

---

## 1. Reconnaissance (Admin Workflow)

I began by logging in as the `administrator` to analyze how the "Upgrade User" functionality works. I observed that the operation is not a single request but a **Multi-Step Process**.

1.  **Step 1:** The admin selects a user to upgrade. The server probably verifies permissions here.
    ![[Pasted image 20251124181443.png]]

2.  **Step 2:** A confirmation page/request is sent to finalize the action (e.g., "Are you sure?").
    ![[Pasted image 20251124181504.png]]

I captured both requests in Burp Proxy for analysis.

---

## 2. Exploitation Attempts

I logged out of the admin account and logged in as the attacker, `wiener`. I attempted to replay the administrative requests using my low-privileged session.

### Attempt 1: Replaying Step 1
I sent the first request (the initial upgrade command) to Burp Repeater.
The server correctly enforced access control and returned an **Unauthorized** response.

![[Pasted image 20251124181838.png]]

### Attempt 2: Replaying Step 2 (The Bypass)
I hypothesized that the developers might have assumed that a user could only reach Step 2 if they had successfully passed Step 1. Therefore, they might have neglected to place access controls on the second request.

I sent the **confirmation request** (Step 2) using `wiener`'s session cookies.

```http
POST /admin-roles HTTP/1.1
...
action=upgrade&confirmed=true&username=wiener
```

![[Pasted image 20251124181918.png]]

### Result

The hypothesis was correct. The server accepted the second request without checking if the user was an administrator. The account `wiener` was successfully promoted.

![[Pasted image 20251124181957.png]]

